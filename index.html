<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SMART VISION — Vanavil Mandram 2025</title>

  <!-- TensorFlow + Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

  <style>
    :root{
      --ocean-900:#032735; --ocean-700:#0b74de; --ocean-500:#39a1ff; --muted:#6f8396;
      --card:#ffffff; --bg:#f7fbff; --radius:14px;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
    body{background:linear-gradient(180deg,#eaf6ff 0%, #f7fbff 100%); color:var(--ocean-900); -webkit-font-smoothing:antialiased;}
    .wrap{max-width:1100px;margin:18px auto;padding:24px 12px;text-align:center}
    .badge{display:inline-block;margin:0 auto 6px;background:var(--ocean-700);color:#fff;padding:16px 28px;border-radius:12px;font-weight:1000;font-size:20px}
    h1{font-size:30px;margin:8px 0 6px}
    .hero{display:flex;justify-content:center;margin:10px 0 12px;border-radius:12px;overflow:hidden;box-shadow:0 16px 40px rgba(6,20,40,0.06);max-width:1024px}
    /* hero image: responsive for phone, no strict fixed height */
    .hero img{width:100%;height:auto;max-height:800px;object-fit:cover;display:block}
    .stage{display:grid;grid-template-columns:120px 1fr 120px;gap:12px;align-items:start;margin-top:12px}
    .side-stack{display:flex;flex-direction:column;gap:12px;align-items:center}
    .side-stack img{width:100%;height:120px;object-fit:cover;border-radius:10px;box-shadow:0 6px 18px rgba(6,20,40,0.06);}
    .center-card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 10px 30px rgba(6,20,40,0.06);display:flex;flex-direction:column;align-items:center;gap:10px}
    video#webcam{width:100%;max-width:520px;border-radius:10px;background:#000;aspect-ratio:4/3;object-fit:cover;box-shadow:0 8px 30px rgba(6,20,40,0.06)}
    .ocean-controls{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
    .ocean-controls button{border:0;padding:10px 16px;border-radius:8px;font-weight:800;color:#fff;cursor:pointer;min-width:150px}
    .ocean-controls .start{background:linear-gradient(90deg,#39a1ff,#0b74de)}
    .ocean-controls .stop{background:linear-gradient(90deg,#ff6b6b,#ff3b3b)}
    .ocean-controls .connect{background:linear-gradient(90deg,#0b74de,#055fa8)}
    .ocean-controls .csv{background:linear-gradient(90deg,#2b9bde,#0b74de)}
    .status{color:#02283a;font-weight:700;margin-top:8px;background: rgba(255,255,255,0.95);padding:8px 12px;border-radius:8px;display:inline-block}
    .bottom-gallery{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:18px}
    .bottom-gallery img{width:100%;height:140px;object-fit:cover;border-radius:8px;box-shadow:0 8px 24px rgba(6,20,40,0.05)}
    .counters{display:inline-flex;gap:12px;margin-top:8px}
    .counter{background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 6px 14px rgba(6,20,40,0.04);font-weight:800}
    footer{text-align:center;margin-top:18px;color:var(--muted);font-size:13px}
    #errorBox{display:none;position:fixed;left:12px;right:12px;bottom:12px;padding:10px;background:#fff3cd;border:1px solid #f5c6cb;border-radius:8px;z-index:9999}
    @media (max-width:960px){ .stage{grid-template-columns:80px 1fr 80px} .side-stack img{height:100px} .bottom-gallery{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){ .stage{grid-template-columns:1fr;row-gap:12px} .side-stack{flex-direction:row} .side-stack img{width:44%;height:100px} .hero img{max-width:340px} .bottom-gallery img{height:92px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="badge">VANAVIL MANDRAM — 2025</div>
       <h1>Focal Theme: <strong>Local Solutions for Global Challenges</strong></h1>
         <h2>Sub-theme: <strong>Scientific Solutions to Environmental Challenges – Plastic Pollution</strong></h2>
     </header>

    <!-- HERO: poster10 (1024x600) from your GitHub assets -->
    <div class="hero" aria-hidden="false">
      <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster10.png"
           alt="Main poster (hero) 1024x600" width="1024" height="600"
           onerror="this.onerror=null;this.src='https://via.placeholder.com/1024x600.png?text=Hero+Image'">
    </div>

    <!-- MAIN STAGE (left posters, center camera, right posters) -->
    <div class="stage" role="region" aria-label="Main demo stage">
      <!-- left posters -->
      <div class="side-stack" aria-hidden="false">
        <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster6.jpg" alt="poster6">
        <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster8.jpg" alt="poster8">
      </div>

      <!-- center card -->
      <div class="center-card">
        <video id="webcam" playsinline muted></video>

        <div class="ocean-controls" role="toolbar" aria-label="controls">
          <button id="startBtn" class="start">Start Camera & Load Model</button>
          <button id="stopBtn" class="stop">Stop Camera</button>
          <button id="connectBtn" class="connect">Connect micro:bit (USB)</button>
          <button id="downloadCsv" class="csv">Download CSV</button>
        </div>

        <div class="status" id="statusText">Status: idle</div>

        <div class="counters" aria-live="polite">
          <div class="counter">Fish: <span id="fishCountDisplay">0</span></div>
          <div class="counter">Trash: <span id="trashCountDisplay">0</span></div>
          <div class="counter">Emerg: <span id="emergCountDisplay">0</span></div>
        </div>
      </div>

      <!-- right posters -->
      <div class="side-stack">
        <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster7.jpg" alt="poster7">
        <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster9.jpg" alt="poster9">
      </div>
    </div>

    <!-- bottom gallery (poster1..poster5) -->
    <div class="bottom-gallery" aria-label="Poster gallery">
      <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster1.jpg" alt="poster1">
      <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster2.jpg" alt="poster2">
      <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster3.jpg" alt="poster3">
      <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster4.jpg" alt="poster4">
      <img src="https://raw.githubusercontent.com/iyyappanbrte1984/sss/main/assets/poster5.jpg" alt="poster5">
    </div>

    <footer>© Vanavil Mandram • SMART VISION FOR A CLEANER OCEAN — 2025</footer>
  </div>

  <div id="errorBox"><strong>Debug:</strong><pre id="errorText" style="white-space:pre-wrap"></pre></div>

  <script>
    /* ---------- CONFIG ---------- */
    const MODEL_URL = 'model/model.json';
    const METADATA_URL = 'model/metadata.json';
    const SEND_CONFIDENCE_THRESHOLD = 0.60;
    const PREDICT_INTERVAL_MS = 600;
    const MICROBIt_SEND_DEBOUNCE_MS = 700;

    /* ---------- STATE ---------- */
    let tmModel = null;
    let videoEl = document.getElementById('webcam');
    let stream = null;
    let isPredicting = false;
    let predictionsLog = [];

    let webFishCount = 0, webTrashCount = 0, webEmergCount = 0;

    // Web Serial state
    let serialPort = null;
    let serialWriter = null;
    let _lastMicrobitSendAt = 0;

    /* ---------- UI helpers ---------- */
    function showStatus(text){ document.getElementById('statusText').textContent = 'Status: ' + text; }
    function showError(e){
      const box = document.getElementById('errorBox'), txt = document.getElementById('errorText');
      txt.textContent = (e && e.stack) ? e.stack : String(e);
      box.style.display = 'block';
      showStatus('error: ' + (e && e.message ? e.message : e));
      console.error(e);
    }
    function updateWebCountersUI(){
      document.getElementById('fishCountDisplay').textContent = String(webFishCount);
      document.getElementById('trashCountDisplay').textContent = String(webTrashCount);
      document.getElementById('emergCountDisplay').textContent = String(webEmergCount);
    }

    /* ---------- micro:bit send over USB (debounced) ---------- */
    async function sendCodeToMicrobit(code){
      if (!serialWriter || !code) return;
      const now = Date.now();
      if (now - _lastMicrobitSendAt < MICROBIt_SEND_DEBOUNCE_MS) return;
      _lastMicrobitSendAt = now;
      try {
        await serialWriter.write(code + '\n');
        console.log('Sent to micro:bit ->', code);
      } catch(err){ console.warn('microbit write failed', err); }
    }

    /* ---------- CAMERA & MODEL ---------- */
    async function startCameraAndModel(){
      if (isPredicting) return;
      showStatus('starting camera & model...');
      try {
        if (!tmModel) tmModel = await tmImage.load(MODEL_URL, METADATA_URL);
        stream = await navigator.mediaDevices.getUserMedia({
          video:{facingMode:'environment', width:{ideal:1280}, height:{ideal:720}}, audio:false
        });
        videoEl.srcObject = stream;
        await videoEl.play();
        isPredicting = true;
        document.getElementById('startBtn').textContent = 'Camera running';
        showStatus('camera running, model active');

        // Notify micro:bit that camera is on
        await sendCodeToMicrobit('YES');

        predictLoop();
      } catch(err){ showError(err); }
    }

    function stopCamera(){
      if (stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
      isPredicting = false;
      document.getElementById('startBtn').textContent = 'Start Camera & Load Model';
      showStatus('camera stopped');
    }

    function labelToCode(label){
      if (!label) return null;
      const low = String(label).toLowerCase();
      if (low.includes('fish')) return 'F';
      if (low.includes('trash')) return 'T';
      if (low.includes('emerg') || low.includes('emergency')) return 'E';
      return null;
    }

       async function predictLoop(){
      try {
        if (!tmModel) throw new Error('Model not loaded');
        const preds = await tmModel.predict(videoEl, false);
        preds.sort((a,b)=>b.probability - a.probability);
        const top = preds[0] || {className:'--', probability:0};
        const pct = Math.round(top.probability * 100);
        showStatus(`live · ${pct}% · ${top.className || '--'}`);
        predictionsLog.push({t:Date.now(), label: top.className, conf: top.probability});

        if (top.probability >= SEND_CONFIDENCE_THRESHOLD){
          const code = labelToCode(top.className);

          if (code === 'F'){
            webFishCount++;
            updateWebCountersUI();
            await sendCodeToMicrobit('F');

          } else if (code === 'T'){
            webTrashCount++;
            updateWebCountersUI();
            await sendCodeToMicrobit('T');

          } else if (code === 'E'){
            webEmergCount++;
            updateWebCountersUI();
            await sendCodeToMicrobit('E');

            if (webEmergCount >= 5) {
              await sendCodeToMicrobit('ALARM');
              showStatus('ALARM sent to micro:bit');
            }
          }
        }

        if (isPredicting) {
          setTimeout(() => requestAnimationFrame(predictLoop), PREDICT_INTERVAL_MS);
        }
      } catch(e){
        showError(e);
      }
    }

    function downloadCSV(){
      if (predictionsLog.length === 0){ alert('No predictions recorded yet'); return; }
      const header=['timestamp','label','confidence'];
      const rows = predictionsLog.map(r=>[new Date(r.t).toISOString(), r.label, r.conf]);
      const csv = [header, ...rows].map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'predictions.csv';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
    }

    /* ---------- WEB SERIAL / micro:bit over USB ---------- */

    async function connectMicrobit() {
      // secure origin check (GitHub Pages is HTTPS so ok)
      if (!(location.protocol === 'https:' || location.hostname === 'localhost')) {
        alert('Web Serial requires HTTPS or http://localhost. Open this page over HTTPS.');
        return;
      }

      if (!('serial' in navigator)) {
        alert('Web Serial API not available. Use recent Chrome / Edge on desktop.');
        return;
      }

      try {
        showStatus('Requesting USB micro:bit...');
        serialPort = await navigator.serial.requestPort();
        await serialPort.open({ baudRate: 115200 });

        // Writer (web -> micro:bit)
        const textEncoder = new TextEncoderStream();
        textEncoder.readable.pipeTo(serialPort.writable);
        serialWriter = textEncoder.writable.getWriter();

        // Reader (micro:bit -> web)
        const textDecoder = new TextDecoderStream();
        serialPort.readable.pipeTo(textDecoder.writable);
        const reader = textDecoder.readable.getReader();

        showStatus('micro:bit USB connected');

        (async function readLoop() {
          try {
            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              if (value) {
                // value may contain multiple lines; split
                const lines = value.replace(/\r/g,'').split('\n');
                for (const line of lines) {
                  const trimmed = line.trim();
                  if (trimmed) handleIncomingFromMicrobit(trimmed);
                }
              }
            }
          } catch (e) {
            console.error('Serial read error', e);
            showStatus('micro:bit USB disconnected');
          }
        })();

      } catch (err) {
        console.error('connectMicrobit error:', err);
        showStatus('micro:bit USB connection failed');
        alert('USB connection error: ' + (err && err.message ? err.message : String(err)) +
              '\n\nCheck:\n• micro:bit is connected by USB\n• You select the micro:bit device in the dialog\n• No other program is using the serial port.');
      }
    }

    function handleIncomingFromMicrobit(raw){
  console.log('From micro:bit ->', raw);

  if (raw === 'LOGO_TOGGLE'){
    if (isPredicting) stopCamera(); else startCameraAndModel();
    return;
  }

  if (raw === 'BTN_A' || raw === 'BTN_B' || raw === 'BTN_AB'){
    // Always send current counts, even while camera is running
    const out = `COUNT:F:${webFishCount},T:${webTrashCount},E:${webEmergCount}`;
    sendCodeToMicrobit(out);
    showStatus('Sent counts to micro:bit');
    return;
  }
}


    /* ---------- WIRES ---------- */
    document.getElementById('startBtn').addEventListener('click', startCameraAndModel);
    document.getElementById('stopBtn').addEventListener('click', stopCamera);
    document.getElementById('downloadCsv').addEventListener('click', downloadCSV);
    document.getElementById('connectBtn').addEventListener('click', connectMicrobit);

    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden && stream){
        stopCamera();
        showStatus('camera stopped (page hidden)');
      }
    });

    console.log('SMART VISION page loaded with Web Serial micro:bit support.');
  </script>
</body>
</html>
