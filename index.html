<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SMART VISION FOR A CLEANER OCEAN ‚Äî Vanavil Mandram 2025</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">

  <!-- TFJS + Teachable Machine (compatible versions) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

  <style>
    :root{
      --ocean-900:#032735;
      --ocean-700:#0b74de;
      --ocean-500:#39a1ff;
      --muted:#6f8396;
      --card:#ffffff;
      --bg:#f7fbff;
      --ocean-box: linear-gradient(90deg, rgba(11,116,222,0.95), rgba(6,92,179,0.95));
      --glass: rgba(255,255,255,0.92);
      --radius:14px;
    }

    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#eaf6ff 0%, #f7fbff 100%); color:var(--ocean-900); -webkit-font-smoothing:antialiased;}

    /* Page wrapper spacing so bottom gallery isn't clipped */
/* ---------- Header & wrapper (center everything) ---------- */
.wrap {
  max-width:1100px;
  margin: 18px auto;         /* centered container */
  padding: 24px 12px;
  box-sizing: border-box;
  text-align: center;        /* ensure children default to centered text */
}

/* keep header content centered explicitly */
header {
  text-align: center !important;
  display: block;
}

/* make badge/title slightly larger but centered */
.badge {
  display: inline-block;
  margin: 0 auto 6px;
  background: var(--ocean-700);
  color: #fff;
  padding: 8px 14px;
  border-radius: 12px;
  font-weight: 800;
  font-size: 13px;
  box-shadow: 0 8px 20px rgba(11,20,40,0.06);
}

/* Title & meta centered and constrained */
h1 { font-size: 24px; margin: 6px 0 4px; text-align:center; }
.subtitle, .meta, .motto { text-align:center; margin: 2px 0; color: var(--muted); }

/* ---------- Hero and stage remain centered ---------- */
.hero { display:flex; justify-content:center; margin: 10px 0 12px; }
.center-card { margin: 0 auto; } /* ensure card centers */

/* ---------- Bottom gallery: center and prevent clipping ---------- */
.bottom-gallery {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;   /* CENTER the whole gallery row */
  gap:12px;
  margin: 22px 0 48px;      /* add bottom margin so nothing clips */
  padding: 6px 8px;
  box-sizing: border-box;
}

/* make each thumbnail a fixed max-width but responsive */
.bottom-gallery img {
  width: calc(20% - 12px);   /* 5 across on wide screens */
  max-width: 180px;
  min-width: 110px;
  height: 110px;             /* comfortable thumbnail height */
  object-fit: cover;
  border-radius: 8px;
  box-shadow: 0 8px 20px rgba(6,20,40,0.06);
  background: #fff;
}

/* small screens: 2 or 3 columns and smaller thumbnails */
@media (max-width:960px){
  .bottom-gallery img { width: calc(33.333% - 12px); height:100px; min-width:120px; }
}
@media (max-width:600px){
  .bottom-gallery img { width: calc(50% - 12px); height:92px; min-width:100px; }
}

/* ---------- Small safety: keep left/right side stacks from shifting layout ---------- */
.side-stack { display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:flex-start; }

/* ensure stage grid stays centered on small screens */
@media (max-width:720px){
  .stage { grid-template-columns: 1fr; row-gap: 14px; padding: 0 6px; }
  .side-stack { flex-direction:row; gap:10px; justify-content:center; }
}


    /* Main stage: left posters, center camera, right posters */
    .stage{display:grid;grid-template-columns:120px 1fr 120px;gap:12px;align-items:start;margin-top:12px}
    .side-stack{display:flex;flex-direction:column;gap:12px;align-items:center}
    .side-stack img{width:100%;height:120px;object-fit:cover;border-radius:10px;box-shadow:0 6px 18px rgba(6,20,40,0.06);}

    .center-card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 10px 30px rgba(6,20,40,0.06);display:flex;flex-direction:column;align-items:center;gap:10px}
    video#webcam{width:100%;max-width:520px;border-radius:10px;background:#000;aspect-ratio:4/3;object-fit:cover;box-shadow:0 8px 30px rgba(6,20,40,0.06)}
    /* ------- Replace old ocean-controls + status styles with this ------- */

/* ocean-controls: container transparent; buttons have gradient */
.ocean-controls{
  background: transparent;
  border-radius:10px;
  padding:8px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  width:100%;
  max-width:520px;
  flex-wrap:wrap;
}

/* button base */
.ocean-controls button{
  border:0;
  padding:10px 16px;
  border-radius:8px;
  font-weight:800;
  color:#fff;
  cursor:pointer;
  min-width:160px;
  box-shadow:0 8px 18px rgba(7,20,50,0.12);
  transition:transform .12s ease, box-shadow .12s ease, opacity .12s;
}

/* per-button gradients */
.ocean-controls button.start{
  background: linear-gradient(90deg,#39a1ff,#0b74de);
}
.ocean-controls button.connect{
  background: linear-gradient(90deg,#0b74de,#055fa8);
}
.ocean-controls button.csv{
  background: linear-gradient(90deg,#2b9bde,#0b74de);
}

/* hover / active */
.ocean-controls button:hover{ transform:translateY(-3px); box-shadow:0 14px 30px rgba(7,20,50,0.14); }
.ocean-controls button:active{ transform:translateY(0); box-shadow:0 6px 12px rgba(7,20,50,0.08); }

/* status: higher contrast, visible */
.status{
  color:#02283a;            /* darker for readability */
  font-weight:700;
  margin-top:8px;
  background: rgba(255,255,255,0.95);
  padding:8px 12px;
  border-radius:8px;
  box-shadow: 0 6px 14px rgba(6,20,40,0.04);
  font-size:14px;
  text-align:center;
  display:inline-block;
}

/* label and confidence improved contrast */
.label{
  flex:1;
  font-weight:800;
  color:var(--ocean-900);
  background:#ffffff;
  padding:8px 10px;
  border-radius:8px;
  text-align:center;
  box-shadow: 0 6px 14px rgba(6,20,40,0.03);
}
.confidence{ width:180px; height:12px; background:#eaf6ff; border-radius:8px; overflow:hidden; border:1px solid rgba(10,30,60,0.04); }
.confidence > i{ display:block; height:100%; background:linear-gradient(90deg,#39a1ff,var(--ocean-700)); width:0%; transition:width .18s ease; }

    /* Bottom gallery full width */
    .bottom-gallery{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:18px}
    .bottom-gallery img{width:100%;height:140px;object-fit:cover;border-radius:8px;box-shadow:0 8px 24px rgba(6,20,40,0.05)}

    footer{text-align:center;margin-top:18px;color:var(--muted);font-size:13px}

    /* Responsive tweaks */
    @media (max-width:960px){
      .stage{grid-template-columns:80px 1fr 80px}
      .side-stack img{height:100px}
      .bottom-gallery{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:600px){
      .stage{grid-template-columns:1fr;row-gap:12px}
      .side-stack{flex-direction:row;justify-content:center}
      .side-stack img{width:44%;height:100px}
      .bottom-gallery{grid-template-columns:repeat(2,1fr)}
      .hero img{max-width:340px}
    }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="badge">VANAVIL MANDRAM ‚Äî 2025</div>
      <div class="meta">Focal Theme: <strong>Local Solutions for Global Challenges</strong></div>
      <div class="meta">Sub-theme: <strong>Scientific Solutions to Environmental Challenges ‚Äì Plastic Pollution</strong></div>
      <h1>üåä SMART VISION FOR A CLEANER OCEAN</h1>
      <div class="subtitle">‚ÄúSee. Sense. Save ‚Äî Using Smart Vision to Keep Our Oceans Blue.‚Äù</div>
      <div class="motto">Motto: ‚ÄúA clean ocean begins with a clear vision.‚Äù</div>
    </header>

    <!-- hero poster top center -->
    <div class="hero">
    <img src="assets/poster10.jpg" alt="Main poster" id="heroPoster" onerror="this.style.display='none'">
    </div>

    <!-- main stage: left posters, camera center, right posters -->
    <div class="stage" role="region" aria-label="Main demo stage">
      <!-- left stacked posters: poster6, poster8 -->
      <div class="side-stack" aria-hidden="false">
        <img src="assets/poster6.jpg" alt="poster6">
        <img src="assets/poster8.jpg" alt="poster8">
      </div>

      <!-- center camera card -->
      <div class="center-card">
        <video id="webcam" playsinline muted></video>

        <div class="ocean-controls" role="toolbar" aria-label="controls">
          <button id="startBtn" class="start">Start Camera & Load Model</button>
          <button id="connectBtn" class="connect">Connect micro:bit</button>
          <button id="downloadCsv" class="csv">Download CSV</button>
        </div>

        <div class="status" id="statusText">Status: idle</div>

        <div class="labelbar" aria-live="polite">
          <div class="label" id="label">Label: --</div>
          <div class="confidence" aria-hidden="true"><i id="confFill"></i></div>
        </div>
      </div>

      <!-- right stacked posters: poster7, poster9 -->
      <div class="side-stack">
        <img src="assets/poster7.jpg" alt="poster7">
        <img src="assets/poster9.jpg" alt="poster9">
      </div>
    </div>

    <!-- bottom gallery with poster1..poster5 -->
    <div class="bottom-gallery" aria-label="Poster gallery">
      <img src="assets/poster1.jpg" alt="poster1">
      <img src="assets/poster2.jpg" alt="poster2">
      <img src="assets/poster3.jpg" alt="poster3">
      <img src="assets/poster4.jpg" alt="poster4">
      <img src="assets/poster5.jpg" alt="poster5">
    </div>

    <footer>¬© Vanavil Mandram ‚Ä¢ SMART VISION FOR A CLEANER OCEAN ‚Äî Showcase 2025</footer>
  </div>

  <!-- Debug box -->
  <div id="errorBox" style="display:none;position:fixed;left:12px;right:12px;bottom:12px;padding:10px;background:#fff3cd;border:1px solid #f5c6cb;border-radius:8px;z-index:9999;font-family:Inter,Arial;">
    <strong>Debug:</strong>
    <pre id="errorText" style="white-space:pre-wrap"></pre>
  </div>

  <script>
    // update if your model path differs
    const MODEL_URL = 'model/model.json';
    const METADATA_URL = 'model/metadata.json';

    let tmModel = null;
    let videoEl = document.getElementById('webcam');
    let stream = null;
    let isPredicting = false;
    let predictionsLog = [];

    function showStatus(text){ document.getElementById('statusText').textContent = 'Status: ' + text; }
    function showError(e){
      const box = document.getElementById('errorBox');
      const txt = document.getElementById('errorText');
      txt.textContent = (e && e.stack) ? e.stack : String(e);
      box.style.display = 'block';
      showStatus('error: ' + (e && e.message ? e.message : e));
      console.error(e);
    }

    async function startCameraAndModel(){
      showStatus('starting...');
      try {
        const r = await fetch(MODEL_URL);
        if (!r.ok) throw new Error('Model not found at ' + MODEL_URL + ' (HTTP ' + r.status + ')');

        showStatus('loading model...');
        tmModel = await tmImage.load(MODEL_URL, METADATA_URL);
        if (!tmModel) throw new Error('Failed to load model');

        showStatus('starting camera...');
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        videoEl.srcObject = stream;
        await videoEl.play();
        showStatus('camera ready');

        isPredicting = true;
        predictLoop();
      } catch(err) {
        showError(err);
      }
    }

    async function predictLoop(){
      try {
        if (!tmModel) throw new Error('Model not loaded');
        const preds = await tmModel.predict(videoEl, false);
        if (!Array.isArray(preds)) throw new Error('Unexpected prediction returned');
        preds.sort((a,b)=>b.probability - a.probability);
        const top = preds[0] || {className:'--',probability:0};
        document.getElementById('label').textContent = 'Label: ' + top.className;
        const pct = Math.round(top.probability * 100);
        document.getElementById('confFill').style.width = pct + '%';
        showStatus('live ¬∑ ' + pct + '%');

        predictionsLog.push({t: Date.now(), label: top.className, conf: top.probability});
        if (isPredicting) setTimeout(()=>requestAnimationFrame(predictLoop), 300);
      } catch(e){
        showError(e);
      }
    }

    function downloadCSV(){
      if (predictionsLog.length === 0){ alert('No predictions recorded yet'); return; }
      const header = ['timestamp','label','confidence'];
      const rows = predictionsLog.map(r=>[new Date(r.t).toISOString(), r.label, r.conf]);
      const csv = [header, ...rows].map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'predictions.csv'; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
    }

    async function connectMicrobit(){
      if (!('bluetooth' in navigator)){ alert('Web Bluetooth not supported. Use Chrome on Android or desktop.'); return; }
      try {
        showStatus('requesting micro:bit...');
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'BBC micro:bit' }],
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
        });
        showStatus('connecting...');
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        const tx = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
        window._microbitTx = tx;
        showStatus('micro:bit connected');
        alert('micro:bit connected. Page can send messages.');
      } catch(err){ showError(err); }
    }

    // wire buttons
    document.getElementById('startBtn').addEventListener('click', startCameraAndModel);
    document.getElementById('downloadCsv').addEventListener('click', downloadCSV);
    document.getElementById('connectBtn').addEventListener('click', connectMicrobit);

    // optional micro:bit notifier: sends label text when it changes
    (function microbitNotifierLoop(){
      let lastLabel = null;
      setInterval(async ()=>{
        if (!tmModel || !window._microbitTx) return;
        if (predictionsLog.length === 0) return;
        const last = predictionsLog[predictionsLog.length - 1];
        if (!last) return;
        if (last.label !== lastLabel){
          lastLabel = last.label;
          try {
            const payload = (last.label + '\n');
            const enc = new TextEncoder();
            await window._microbitTx.writeValue(enc.encode(payload));
          } catch(e){ console.warn('microbit send failed', e); }
        }
      }, 1200);
    })();

    // stop camera on page hidden to save battery
    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden && stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
        showStatus('camera stopped (page hidden)');
      }
    });
  </script>
</body>
</html>
