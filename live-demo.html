<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Demo — SMART VISION</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700,900&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#06a6ff;--bg:#f6fbff;--muted:#6f8396}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,var(--bg),#fff);color:#032735}
    nav{display:flex;gap:18px;align-items:center;padding:14px 20px;background:linear-gradient(90deg,#0077be,#00a8e8);color:#fff}
    nav a{color:#fff;text-decoration:none;font-weight:700}
    .wrap{max-width:1000px;margin:20px auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(6,20,40,0.06)}
    video{width:100%;border-radius:8px;background:#000;object-fit:cover}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),#0b74de);color:#fff;font-weight:700;cursor:pointer}
    label{display:block;margin-top:10px;font-size:13px;color:var(--muted)}
    input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #eef6ff;margin-top:6px}
    .muted{color:var(--muted);font-size:13px}
    footer{text-align:center;color:var(--muted);margin-top:18px;font-size:13px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="live-demo.html">Live Demo</a>
    <a href="marine-dashboard.html">Dashboard</a>
  </nav>

  <main class="wrap">
    <h2 style="margin:0 0 6px">Live Demo — Smart Vision Submarine</h2>
    <div class="muted">Camera preview • Record samples • Ask AI (Perplexity)</div>

    <div class="grid" style="margin-top:14px">
      <div class="card">
        <video id="webcam" playsinline muted></video>
        <div style="margin-top:10px" class="controls">
          <button id="startCam" class="btn">Start Camera</button>
          <button id="stopCam" class="btn" style="background:linear-gradient(90deg,#ff6b6b,#ff3b3b)">Stop Camera</button>
          <button id="snapshot" class="btn" style="background:linear-gradient(90deg,#05c46b,#0b7c3e)">Snapshot</button>
        </div>
        <div id="camStatus" class="muted" style="margin-top:8px">Camera: stopped</div>
      </div>

      <aside class="card">
        <h3 style="margin-top:0">Record Sample</h3>
        <label>Location</label>
        <input id="location" placeholder="Kombai-01">
        <label>pH</label><input id="ph" type="number" step="0.01" placeholder="7.8">
        <label>Temperature (°C)</label><input id="temperature" type="number" step="0.1" placeholder="28.2">
        <label>Salinity (PSU)</label><input id="salinity" type="number" step="0.1" placeholder="34.1">
        <label>Dissolved O₂ (mg/L)</label><input id="dox" type="number" step="0.1" placeholder="6.0">
        <label>Turbidity (NTU)</label><input id="turb" type="number" step="0.1" placeholder="3.3">

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="logSample" class="btn">Log Sample</button>
          <button id="askAI" class="btn" style="background:linear-gradient(90deg,#05c46b,#0b7c3e)">Request AI</button>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Last AI response:</div>
          <textarea id="aiResult" readonly style="width:100%;height:120px;border-radius:8px;border:1px solid #eef6ff;padding:8px;margin-top:6px"></textarea>
        </div>
      </aside>
    </div>

    <footer>© SMART VISION • Use modern Chrome/Edge for camera & Web Serial.</footer>
  </main>

  <script>
    const API_BASE = "/.netlify/functions"; // Netlify functions base

    // camera
    const video = document.getElementById("webcam");
    const startBtn = document.getElementById("startCam");
    const stopBtn = document.getElementById("stopCam");
    const snapBtn = document.getElementById("snapshot");
    const camStatus = document.getElementById("camStatus");
    let stream = null;

    async function startCamera(){
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: 'environment' }, audio:false });
        video.srcObject = stream; await video.play();
        camStatus.textContent = "Camera: running";
      } catch(e){
        console.error(e); camStatus.textContent = "Camera error: " + e.message;
      }
    }
    function stopCamera(){
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; video.srcObject = null; camStatus.textContent = "Camera: stopped"; }
    }
    function snapshotImage(){
      if (!video || !stream) return alert('Start camera first');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 640; canvas.height = video.videoHeight || 480;
      const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width,canvas.height);
      return canvas.toDataURL('image/jpeg', 0.85);
    }

    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    snapBtn.addEventListener('click', ()=> {
      const dataUrl = snapshotImage();
      if (dataUrl) alert('Snapshot captured (not uploaded). Use sample fields to save readings.');
    });

    // read form
    function readForm(){
      return {
        location: document.getElementById('location').value || 'unknown',
        ph: parseFloat(document.getElementById('ph').value) || null,
        temperature: parseFloat(document.getElementById('temperature').value) || null,
        salinity: parseFloat(document.getElementById('salinity').value) || null,
        dissolvedOxygen: parseFloat(document.getElementById('dox').value) || null,
        turbidity: parseFloat(document.getElementById('turb').value) || null
      };
    }

    // POST sample to Netlify function
    async function postSample(sample){
      try {
        const res = await fetch(`${API_BASE}/log-sample`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(sample)
        });
        const json = await res.json();
        return json;
      } catch(err){
        console.error('postSample', err); throw err;
      }
    }

    // Ask server AI (Perplexity via serverless)
    async function askAI(latestSample){
      try {
        document.getElementById('aiResult').value = 'Requesting AI...';
        const res = await fetch(`${API_BASE}/marine-ai`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ latestSample })
        });
        const json = await res.json();
        if (json.ai_text) {
          document.getElementById('aiResult').value = String(json.ai_text).slice(0,10000);
        } else {
          document.getElementById('aiResult').value = JSON.stringify(json, null, 2);
        }
      } catch(e){
        console.error(e); document.getElementById('aiResult').value = 'AI request failed: ' + (e.message || e);
      }
    }

    document.getElementById('logSample').addEventListener('click', async ()=>{
      const sample = readForm();
      if (!sample.ph && !sample.temperature) return alert('Enter at least pH or temperature');
      try {
        const result = await postSample(sample);
        alert('Sample logged. ID: ' + (result.inserted?.id || 'unknown'));
      } catch(e){ alert('Failed to log sample'); }
    });

    document.getElementById('askAI').addEventListener('click', async ()=>{
      // prefer using last inserted sample from API -> latest-samples
      try {
        const rows = await fetch(`${API_BASE}/latest-samples?limit=1`).then(r => r.json());
        const latest = (rows && rows[0]) || readForm();
        await askAI(latest);
      } catch(e){
        console.error(e); alert('AI call failed');
      }
    });
  </script>
</body>
</html>
