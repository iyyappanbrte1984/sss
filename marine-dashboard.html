<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marine AI Dashboard ‚Äî SMART VISION</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- NEW: Leaflet for camera event mini-map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kPuqU57J3C0uHfF7nJH2kNFQZkTtWkTgLrjRI="
    crossorigin="">
  </script>

  <style>
    :root{
      --ocean-900:#032735; --ocean-700:#0b74de; --ocean-500:#39a1ff;
      --bg:#f4f9ff; --card:#ffffff; --muted:#6f8396;
      --ok:#1eae60; --warn:#f5a623; --bad:#e63946;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{font-family:"Poppins",sans-serif;background:var(--bg);color:var(--ocean-900);}
    nav{
      position:sticky;top:0;z-index:1000;
      display:flex;justify-content:center;gap:24px;
      padding:12px 24px;
      background:linear-gradient(90deg,#0077be,#00a8e8);
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    nav a{
      color:#fff;text-decoration:none;font-weight:700;font-size:16px;
      padding:8px 20px;border-radius:999px;transition:all .3s;
    }
    nav a:hover{background:rgba(255,255,255,.2);transform:translateY(-2px);}
    .hero-header{
      padding:32px 16px 24px;text-align:center;
      background:linear-gradient(135deg,#005fa3,#00a8e8,#39a1ff);
      color:#fff;box-shadow:0 8px 24px rgba(0,0,0,.15);
    }
    .hero-header h1{font-size:32px;font-weight:900;letter-spacing:.05em;margin-bottom:8px;}
    .hero-header p{font-size:15px;opacity:.95;}

    .wrap{max-width:1200px;margin:30px auto;padding:0 20px;}

    .metrics-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px;margin-bottom:30px;
    }
    .metric-card{
      background:linear-gradient(135deg,#fff,#f8fcff);
      border-radius:16px;padding:24px;
      box-shadow:0 10px 30px rgba(0,119,190,.08);
      border:1px solid rgba(0,119,190,.1);
      transition:all .3s ease;position:relative;overflow:hidden;
    }
    .metric-card::before{
      content:'';position:absolute;top:0;left:0;right:0;height:4px;
      background:linear-gradient(90deg,var(--ocean-700),var(--ocean-500));
    }
    .metric-card:hover{transform:translateY(-4px);box-shadow:0 15px 40px rgba(0,119,190,.15);}
    .metric-label{font-size:13px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.5px;}
    .metric-value{
      font-size:36px;font-weight:900;color:var(--ocean-900);margin:12px 0 8px;
      animation:countUp .8s ease-out;
    }
    .metric-unit{font-size:13px;color:var(--muted);font-weight:500;}
    .metric-status{
      display:inline-block;margin-top:10px;padding:6px 14px;border-radius:20px;
      font-size:12px;font-weight:700;color:#fff;
    }
    .status-ok{background:var(--ok);}
    .status-warn{background:var(--warn);}
    .status-bad{background:var(--bad);}
    @keyframes countUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

    .dashboard-row{
      display:grid;grid-template-columns:2fr 1.2fr;gap:20px;margin-bottom:30px;
    }
    @media(max-width:900px){.dashboard-row{grid-template-columns:1fr;}}

    .chart-card,.ai-card{
      background:#fff;border-radius:16px;padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      border:1px solid rgba(0,119,190,.08);
    }
    .chart-card h3,.ai-card h3{margin-bottom:20px;font-size:18px;color:var(--ocean-900);}
    canvas{width:100%;max-height:280px;}

    #aiText{
      width:100%;min-height:200px;border-radius:10px;
      border:1px solid #e5f0f8;padding:14px;font-size:13px;line-height:1.6;
      resize:vertical;background:#f9fbff;font-family:inherit;
    }
    .btn-group{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;}
    .btn{
      padding:11px 20px;border-radius:10px;border:none;font-weight:700;font-size:13px;
      cursor:pointer;transition:all .3s;flex:1;min-width:140px;
    }
    .btn-primary{background:linear-gradient(135deg,#39a1ff,#0b74de);color:#fff;}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(11,116,222,.3);}
    .btn-success{background:linear-gradient(135deg,#1eae60,#0b7c3e);color:#fff;}
    .btn-success:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(30,174,96,.3);}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}

    .table-card{
      background:#fff;border-radius:16px;padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);margin-top:20px;
      border:1px solid rgba(0,119,190,.08);
    }
    .table-card h3{margin-bottom:18px;font-size:18px;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:12px 10px;text-align:left;border-bottom:1px solid #e5f0f8;}
    th{background:linear-gradient(135deg,#f0f7fc,#e5f0f8);font-weight:700;color:var(--ocean-900);}
    tbody tr{transition:background .2s;}
    tbody tr:hover{background:#f9fbff;}
    .note{margin-top:16px;font-size:12px;color:var(--muted);text-align:center;}

    .loading{
      display:inline-block;width:20px;height:20px;
      border:3px solid rgba(11,116,222,.2);
      border-top-color:#0b74de;border-radius:50%;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}

    footer{margin:30px 0 20px;text-align:center;font-size:13px;color:var(--muted);}
    .refresh-indicator{
      position:fixed;bottom:20px;right:20px;
      background:#fff;padding:10px 16px;border-radius:30px;
      box-shadow:0 4px 12px rgba(0,0,0,.1);font-size:12px;
      display:flex;align-items:center;gap:8px;z-index:1000;
      opacity:0;transition:opacity .3s;
    }
    @keyframes pulseMarker {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
}

.new-detection {
  animation: pulseMarker 2s ease-in-out infinite;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.camera-card {
  animation: slideInUp 0.5s ease-out;
}
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="live-demo.html">Live Demo</a>
    <a href="marine-dashboard.html">Marine AI Dashboard</a>
        <a href="ocean-explorer.html">Ocean Explorer</a>
    <a href="ocean-explorer-pro.html">Ocean Explorer Pro</a>
    <a href="pollution-pathways.html">Pollution Pathways</a>
    <a href="biodiversity-awareness.html">Red List & Self-Assessment</a>
    <a href="sdg-dashboard.html">SDG & Biodiversity</a>
    <a href="presentation-mode.html">Presentation Mode</a>   
  </nav>

  <header class="hero-header">
    <h1>MARINE AI DASHBOARD</h1>
    <p>Real-time ocean parameters + AI health analysis</p>
  </header>

  <main class="wrap">
    <section class="metrics-grid" id="metricsGrid"></section>

    <section class="dashboard-row">
      <div class="chart-card">
        <h3>Temperature Trend (Recent 20 Samples)</h3>
        <canvas id="tempChart"></canvas>
      </div>

      <div class="ai-card">
        <h3>AI Health Insight</h3>
        <textarea id="aiText" readonly placeholder="Click a button below to get AI analysis..."></textarea>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnLocalAI">Local Rules AI</button>
          <button class="btn btn-success" id="btnServerAI">Perplexity AI</button>
        </div>
      </div>
    </section>

    <!-- NEW: Camera events card + mini map + AI analysis -->
    <section id="cameraEventsSection" style="margin-top:24px;">
      <h2 style="font-size:20px;margin-bottom:10px;">AI Camera ‚Äì F/T/E Detections (Last 24 Hours)</h2>

      <div id="cameraCard" style="
          display:flex;flex-wrap:wrap;gap:12px;
          background:#ffffff;border-radius:16px;
          padding:16px;box-shadow:0 10px 30px rgba(0,119,190,.08);
          border:1px solid rgba(0,119,190,.1);">
        <div style="flex:1;min-width:160px;">
          <h3 style="margin:4px 0;font-size:16px;">Detections Summary</h3>
          <p id="cameraSummaryText" style="margin:4px 0;color:#6f8396;font-size:13px;">Loading camera events...</p>
          <ul style="list-style:none;padding:0;margin-top:8px;font-size:13px;">
            <li>üêü Fish detections: <strong id="camFishCount">0</strong></li>
            <li>üóëÔ∏è Trash detections: <strong id="camTrashCount">0</strong></li>
            <li>üö® Emergency detections: <strong id="camEmergCount">0</strong></li>
          </ul>
          <small id="camLastUpdated" style="color:#9aa7b6;font-size:11px;"></small>
        </div>

        <div style="flex:1;min-width:220px;">
          <div id="cameraMap" style="width:100%;height:220px;border-radius:12px;overflow:hidden;"></div>
        </div>
      </div>

      <div style="
          margin-top:12px;
          background:#ffffff;border-radius:16px;
          padding:16px;box-shadow:0 8px 22px rgba(0,0,0,.05);
          border:1px solid rgba(0,119,190,.08);">
        <h3 style="margin-top:0;font-size:16px;">AI Analysis from Camera Events</h3>
        <button id="btnCameraAI" style="
            border:0;padding:8px 14px;border-radius:8px;
            background:linear-gradient(90deg,#39a1ff,#0b74de);
            color:#fff;font-weight:700;cursor:pointer;margin-bottom:8px;font-size:13px;">
          Refresh AI analysis
        </button>
        <textarea id="cameraAiText" readonly
          style="width:100%;min-height:140px;border-radius:8px;border:1px solid #eef6fb;padding:8px;background:#fbfdff;font-size:13px;font-family:inherit;"></textarea>
      </div>
    </section>

    <section class="table-card">
      <h3>Recent Water Quality Samples</h3>
      <table id="dataTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Location</th>
            <th>Time</th>
            <th>pH</th>
            <th>Temp (¬∞C)</th>
            <th>Salinity</th>
            <th>DO (mg/L)</th>
            <th>Turbidity</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="note">Data refreshes automatically every 30 seconds. Add samples via Live Demo page.</p>
    </section>

    <footer>
      Dashboard powered by Vercel + Supabase + Perplexity AI
    </footer>
  </main>

  <div class="refresh-indicator" id="refreshIndicator">
    <div class="loading"></div>
    <span>Loading data...</span>
  </div>
<script>
    const API_BASE = "/api";
    let tempChart = null;
    let currentSamples = [];

    // NEW: camera events map state
    let cameraMap;
    let cameraMarkersLayer;

    function num(v){ return (v == null) ? "‚Äî" : Number(v).toFixed(2); }
    function setAIText(t){ document.getElementById('aiText').value = t; }
    function showRefresh(msg){
      const el = document.getElementById('refreshIndicator');
      el.querySelector('span').textContent = msg;
      el.style.opacity = '1';
      setTimeout(()=>el.style.opacity='0',2000);
    }

    function getLocalPrediction(d){
      if (!d) return {score:0,label:'No data',text:'No sample',status:'status-bad'};
      let score=0;
      if (d.ph>=7.6 && d.ph<=8.4) score+=2; else if (d.ph>=7.2 && d.ph<=8.8) score+=1;
      if (d.temperature>=24 && d.temperature<=30) score+=2; else if (d.temperature>=22 && d.temperature<=32) score+=1;
      if (d.salinity>=33 && d.salinity<=36) score+=2; else if (d.salinity>=30 && d.salinity<=37.5) score+=1;
      const doVal = d.dissolved_oxygen ?? d.dissolvedOxygen;
      if (doVal>=5.5) score+=2; else if (doVal>=4) score+=1;
      if (d.turbidity<=5) score+=2; else if (d.turbidity<=8) score+=1;

      let label,text,status;
      if (score>=8){label="Healthy";text="Overall water quality is GOOD. Keep monitoring.";status="status-ok";}
      else if (score>=5){label="Watch";text="Some parameters are slightly stressed. Investigate causes.";status="status-warn";}
      else{label="Alert";text="Several parameters are outside ideal range. Action needed.";status="status-bad";}
      return {score,label,text,status};
    }

    async function fetchSamples(limit=20){
      try{
        const r = await fetch(`${API_BASE}/latest-samples?limit=${limit}`);
        if(!r.ok) throw new Error("Failed to fetch");
        return await r.json();
      }catch(e){
        console.error("fetchSamples error:",e);
        return [];
      }
    }

    async function renderDashboard(){
      showRefresh("Fetching data...");
      const samples = await fetchSamples(20);
      currentSamples = samples;

      if(samples.length===0){
        showRefresh("No data yet");
        document.getElementById("metricsGrid").innerHTML =
          '<p style="grid-column:1/-1;text-align:center;color:var(--muted);padding:40px">No samples yet. Add data via Live Demo page.</p>';
        return;
      }

      const latest = samples[0];
      const pred = getLocalPrediction(latest);

      const metricsGrid = document.getElementById("metricsGrid");
      metricsGrid.innerHTML = `
        <div class="metric-card">
          <div class="metric-label">Overall Status</div>
          <div class="metric-value">${pred.label}</div>
          <div class="metric-unit">${new Date(latest.recorded_at).toLocaleString()}</div>
          <span class="metric-status ${pred.status}">Score: ${pred.score}/10</span>
        </div>
        <div class="metric-card">
          <div class="metric-label">pH Level</div>
          <div class="metric-value">${num(latest.ph)}</div>
          <div class="metric-unit">Ideal: 7.8‚Äì8.3</div>
          <span class="metric-status ${latest.ph>=7.6 && latest.ph<=8.4 ? 'status-ok':'status-warn'}">Current</span>
        </div>
        <div class="metric-card">
          <div class="metric-label">Temperature</div>
          <div class="metric-value">${num(latest.temperature)}</div>
          <div class="metric-unit">¬∞C (Ideal: 24‚Äì30)</div>
          <span class="metric-status ${latest.temperature>=24 && latest.temperature<=30 ? 'status-ok':'status-warn'}">Current</span>
        </div>
        <div class="metric-card">
          <div class="metric-label">Salinity</div>
          <div class="metric-value">${num(latest.salinity)}</div>
          <div class="metric-unit">PSU (Ideal: 33‚Äì36)</div>
          <span class="metric-status ${latest.salinity>=33 && latest.salinity<=36 ? 'status-ok':'status-warn'}">Current</span>
        </div>
      `;

      const labels = samples.map(s => new Date(s.recorded_at).toLocaleTimeString()).reverse();
      const temps = samples.map(s => Number(s.temperature||0)).reverse();
      const ctx = document.getElementById("tempChart").getContext("2d");
      if(tempChart) tempChart.destroy();
      tempChart = new Chart(ctx,{
        type:"line",
        data:{
          labels,
          datasets:[{
            label:"Temperature (¬∞C)",
            data:temps,
            borderColor:"#0b74de",
            backgroundColor:"rgba(11,116,222,0.1)",
            tension:0.4,
            fill:true,
            pointRadius:4,
            pointHoverRadius:6
          }]
        },
        options:{
          responsive:true,
          plugins:{legend:{display:false}},
          scales:{
            y:{grid:{color:"#f0f7fc"}},
            x:{grid:{display:false}}
          }
        }
      });

      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = samples.map((s,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${s.location || "Unknown"}</td>
          <td>${new Date(s.recorded_at).toLocaleString()}</td>
          <td>${num(s.ph)}</td>
          <td>${num(s.temperature)}</td>
          <td>${num(s.salinity)}</td>
          <td>${num(s.dissolved_oxygen)}</td>
          <td>${num(s.turbidity)}</td>
        </tr>
      `).join("");

      setAIText(`Local Rule-Based Analysis:\n\nStatus: ${pred.label} (${pred.score}/10)\n\n${pred.text}`);
      showRefresh("Data loaded ‚úì");
    }

    // NEW: fetch camera events summary for card + map
    async function loadCameraEventsSummary() {
      try {
        const res = await fetch(`${API_BASE}/camera-events-summary`);
        if (!res.ok) {
          document.getElementById('cameraSummaryText').textContent =
            'Failed to load camera events.';
          return;
        }
        const json = await res.json();
        const counts = json.counts || [];
        const recent = json.recent || [];

        let fish = 0, trash = 0, emerg = 0;
        counts.forEach(row => {
          if (row.code === 'F') fish = row.count;
          if (row.code === 'T') trash = row.count;
          if (row.code === 'E') emerg = row.count;
        });

        document.getElementById('camFishCount').textContent = fish;
        document.getElementById('camTrashCount').textContent = trash;
        document.getElementById('camEmergCount').textContent = emerg;

        const total = fish + trash + emerg;
        if (total === 0) {
          document.getElementById('cameraSummaryText').textContent =
            'No camera detections in the last 24 hours.';
        } else {
          document.getElementById('cameraSummaryText').textContent =
            `Total ${total} detections in the last 24 hours. ` +
            `${fish} fish, ${trash} trash, ${emerg} emergencies.`;
        }
        document.getElementById('camLastUpdated').textContent =
          'Updated at ' + new Date().toLocaleTimeString();

        updateCameraMap(recent);
      } catch (err) {
        console.error('loadCameraEventsSummary error', err);
        document.getElementById('cameraSummaryText').textContent =
          'Error loading camera events.';
      }
    }

    // ***** STEP 5: Real-time Updates *****
    let lastEventId = 0;

    async function checkForNewEvents() {
      try {
        const res = await fetch(`${API_BASE}/camera-events-summary`);
        if (!res.ok) return;
        
        const json = await res.json();
        const recent = json.recent || [];
        
        if (recent.length > 0 && recent[0].id > lastEventId) {
          lastEventId = recent[0].id;
          
          // Flash notification
          showRefresh(`New detection: ${recent[0].label}! üéØ`);
          
          // Add pulse animation to the camera card
          const cameraCard = document.getElementById('cameraCard');
          cameraCard.style.animation = 'none';
          setTimeout(() => {
            cameraCard.style.animation = 'slideInUp 0.5s ease-out';
          }, 10);
          
          // Reload with animation
          await loadCameraEventsSummary();
        }
      } catch (err) {
        console.error('checkForNewEvents error:', err);
      }
    }

    // Check every 5 seconds for new events
    setInterval(checkForNewEvents, 5000);
    // ***** END STEP 5 *****

    function initCameraMap() {
      if (cameraMap) return;
      cameraMap = L.map('cameraMap').setView([20.0, 78.0], 4); // center on India

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(cameraMap);

      cameraMarkersLayer = L.layerGroup().addTo(cameraMap);
    }

    function updateCameraMap(events) {
      initCameraMap();
      cameraMarkersLayer.clearLayers();

      const withLocation = (events || []).filter(e => e.lat && e.lng);
      if (withLocation.length === 0) {
        return; // no coordinates yet
      }

      withLocation.forEach(e => {
        const label = e.label || e.code;
        const time = e.created_at ? new Date(e.created_at).toLocaleString() : '';
        const popup = `
          <strong>${label}</strong><br/>
          Code: ${e.code}<br/>
          Confidence: ${(e.confidence * 100).toFixed(1)}%<br/>
          Time: ${time}
        `;
        L.marker([e.lat, e.lng]).bindPopup(popup).addTo(cameraMarkersLayer);
      });

      const latlngs = withLocation.map(e => [e.lat, e.lng]);
      const bounds = L.latLngBounds(latlngs);
      cameraMap.fitBounds(bounds, { padding: [20, 20] });
    }

    document.getElementById("btnLocalAI").addEventListener("click",()=>{
      if(currentSamples.length===0){alert("No data available");return;}
      const pred = getLocalPrediction(currentSamples[0]);
      setAIText(
        `Local Rule-Based Analysis:\n\nStatus: ${pred.label} (Score: ${pred.score}/10)\n\n${pred.text}\n\nThis is a simple rule-based assessment. For detailed AI analysis, click "Perplexity AI".`
      );
    });

    document.getElementById("btnServerAI").addEventListener("click",async()=>{
      if(currentSamples.length===0){alert("No data available");return;}
      const btn = document.getElementById("btnServerAI");
      try{
        btn.disabled=true;btn.textContent="Analyzing...";
        showRefresh("Requesting AI...");
        const resp = await fetch(`${API_BASE}/marine-ai`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({latestSample:currentSamples[0]})
        });
        const json = await resp.json();
        if(json.ai_text){
          setAIText(json.ai_text);
          showRefresh("AI analysis complete ‚úì");
        }else{
          setAIText("AI Error: "+JSON.stringify(json));
        }
      }catch(e){
        console.error("AI error:",e);
        alert("AI call failed. Check console.");
      }finally{
        btn.disabled=false;btn.textContent="Perplexity AI";
      }
    });

    // NEW: button to request AI summary for camera events
    document.getElementById('btnCameraAI').addEventListener('click', async () => {
      const area = document.getElementById('cameraAiText');
      try {
        area.value = 'Asking AI about camera events...';
        const res = await fetch(`${API_BASE}/camera-events-ai`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ windowHours: 24 })
        });
        if (!res.ok) {
          area.value = 'AI analysis failed. Please try again.';
          return;
        }
        const json = await res.json();
        area.value = json.ai_text || JSON.stringify(json, null, 2);
      } catch (err) {
        console.error('camera-events-ai error', err);
        area.value = 'Error talking to AI endpoint.';
      }
    });

    // Auto-refresh intervals (only once!)
    setInterval(()=>{renderDashboard();},30000); // Water samples every 30s
    setInterval(()=>{loadCameraEventsSummary();},30000); // Camera events every 30s

    // Initialize on page load
    (async function init(){
      await renderDashboard();
      await loadCameraEventsSummary();
      
      // Initialize lastEventId with current latest event
      try {
        const res = await fetch(`${API_BASE}/camera-events-summary`);
        const json = await res.json();
        const recent = json.recent || [];
        if (recent.length > 0) {
          lastEventId = recent[0].id;
        }
      } catch (err) {
        console.error('Failed to initialize lastEventId:', err);
      }
    })();
  </script>

</body>
</html>
