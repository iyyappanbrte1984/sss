<!-- marine-dashboard.html (enhanced: uses latest-samples + Supabase realtime + calls server AI) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marine AI Dashboard — SMART VISION</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700,900&display=swap" rel="stylesheet">

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  <!-- SUPABASE JS (for realtime subscribe) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <style>
    /* (styles preserved from your original file) */
    :root{
      --ocean-900:#032735; --ocean-700:#0b74de; --ocean-500:#39a1ff;
      --bg:#f4f9ff; --card:#ffffff; --muted:#6f8396;
      --ok:#1eae60; --warn:#f5a623; --bad:#e63946;
    }
    *{box-sizing:border-box;}
    html,body{margin:0;font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
    body{background:var(--bg);color:var(--ocean-900);-webkit-font-smoothing:antialiased;}

    nav{
      position:sticky;top:0;z-index:1000;
      display:flex;justify-content:center;gap:24px;
      padding:12px 24px;
      background:linear-gradient(90deg,#0077be,#00a8e8);
    }
    nav a{
      color:#fff;text-decoration:none;font-weight:700;font-size:16px;
      padding:6px 18px;border-radius:999px;
    }
    nav a:hover{background:rgba(255,255,255,0.22);}

    .hero-header{
      padding:26px 16px 18px;
      text-align:center;
      background:linear-gradient(120deg,#005fa3,#00a8e8);
      color:#fff;
      box-shadow:0 8px 24px rgba(0,0,0,0.15);
    }
    .hero-header h1{margin:0;font-size:26px;font-weight:900;letter-spacing:0.04em;}
    .hero-header p{margin:6px 0 0;font-size:14px;opacity:0.9;}

    .wrap{max-width:1150px;margin:24px auto 32px;padding:0 16px;}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
      gap:18px;
      margin-top:20px;
    }
    .card{
      background:var(--card);border-radius:16px;padding:16px 18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.06);
    }
    .card h3{margin:0 0 4px;font-size:18px;}
    .metric-value{font-size:26px;font-weight:800;}
    .metric-unit{font-size:13px;color:var(--muted);}
    .chip{
      display:inline-block;margin-top:8px;padding:6px 12px;border-radius:999px;
      font-size:12px;font-weight:600;color:#fff;
    }
    .chip.ok{background:var(--ok);}
    .chip.warn{background:var(--warn);}
    .chip.bad{background:var(--bad);}

    .row-2{
      display:grid;
      grid-template-columns: minmax(0,2fr) minmax(0,1.5fr);
      gap:18px;
      margin-top:22px;
    }
    @media (max-width:900px){
      .row-2{grid-template-columns:1fr;}
    }

    canvas{width:100%;max-height:260px;}

    #aiBox{min-height:180px;display:flex;flex-direction:column;}
    #aiText{
      flex:1;
      border-radius:10px;
      border:1px solid #dde7f3;
      padding:10px;
      font-size:13px;
      resize:vertical;
      background:#f9fbff;
      white-space:pre-wrap;
    }

    .btn{
      display:inline-block;margin-top:10px;
      padding:9px 15px;border-radius:999px;border:none;
      background:linear-gradient(90deg,#39a1ff,#0b74de);
      color:#fff;font-weight:700;font-size:13px;
      cursor:pointer;
    }
    .btn:disabled{opacity:0.6;cursor:not-allowed;}

    table{
      width:100%;border-collapse:collapse;margin-top:14px;font-size:13px;
    }
    th,td{padding:6px 8px;border-bottom:1px solid #dde7f3;text-align:left;}
    th{background:#edf4ff;}

    .note{margin-top:18px;font-size:12px;color:var(--muted);}
    footer{margin:22px 0 10px;text-align:center;font-size:13px;color:var(--muted);}
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="live-demo.html">Live Demo</a>
    <a href="marine-dashboard.html">Marine AI Dashboard</a>
  </nav>

  <header class="hero-header">
    <h1>MARINE AI DASHBOARD</h1>
    <p>Live-like ocean parameters + AI health summary (real data if connected).</p>
  </header>

  <main class="wrap">
    <!-- metric cards -->
    <section class="grid" id="metricCards"></section>

    <!-- chart + AI section -->
    <section class="row-2">
      <article class="card">
        <h3>Temperature trend (recent)</h3>
        <canvas id="tempChart"></canvas>
      </article>

      <article class="card" id="aiBox">
        <h3>AI Health Insight</h3>
        <textarea id="aiText" readonly>Loading local prediction…</textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="btnLocalAI">Run local rule-based AI</button>
          <button class="btn" id="btnServerAI" style="background:linear-gradient(90deg,#05c46b,#0b7c3e);">Ask external AI</button>
        </div>
      </article>
    </section>

    <!-- table -->
    <section class="card" style="margin-top:22px;">
      <h3>Raw parameter table</h3>
      <table id="dataTable">
        <thead>
          <tr>
            <th>Sample #</th>
            <th>Time</th>
            <th>pH</th>
            <th>Temperature (°C)</th>
            <th>Salinity (PSU)</th>
            <th>DO (mg/L)</th>
            <th>Turbidity (NTU)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="note">
        This view now reads real entries from your backend (Netlify functions + Supabase). Use Live Demo to add data.
      </p>
    </section>

    <footer>Prototype dashboard – tune thresholds and connect real data for your project.</footer>
  </main>

  <script>
    /* ==========
       CONFIG — REPLACE with YOUR values from Supabase Settings → API
       ==========
       Example:
       const SUPABASE_URL = "https://abcd1234.supabase.co";
       const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI...";
    */
    const SUPABASE_URL = "https://gkomibcozmgpjqwymjtn.supabase.co"; // <<-- REPLACE
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdrb21pYmNvem1ncGpxd3ltanRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNDIxNjUsImV4cCI6MjA3OTkxODE2NX0.KOOCWn6ZtF_xkeDV7rbxn9zz-TYfttUp_es5MwFbx30";      // <<-- REPLACE

    const API_BASE = "/.netlify/functions"; // Netlify functions base

    // init supabase client for realtime (anon key is ok in client)
    const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // small helpers
    function number(v){ return (v === null || v === undefined) ? "—" : Number(v).toFixed(2); }
    function setAIText(t){ document.getElementById('aiText').value = t; }

    // local rule-based AI (same logic as before, preserved)
    function getLocalPrediction(d){
      if (!d) return {score:0,label:'No data',text:'No sample'};
      let score = 0;
      if (d.ph >= 7.6 && d.ph <= 8.4) score += 2; else if (d.ph >= 7.2 && d.ph <= 8.8) score += 1;
      if (d.temperature >= 24 && d.temperature <= 30) score += 2; else if (d.temperature >= 22 && d.temperature <= 32) score += 1;
      if (d.salinity >= 33 && d.salinity <= 36) score += 2; else if (d.salinity >= 30 && d.salinity <= 37.5) score += 1;
      if ((d.dissolvedOxygen ?? d.dissolved_oxygen) >= 5.5) score += 2; else if ((d.dissolvedOxygen ?? d.dissolved_oxygen) >= 4) score += 1;
      if ((d.turbidity ?? d.turbidity) <= 5) score += 2; else if ((d.turbidity ?? d.turbidity) <= 8) score += 1;
      let label, text;
      if (score >= 8) { label = "Healthy"; text = "Overall water quality is GOOD. Keep monitoring."; }
      else if (score >= 5) { label = "Watch"; text = "Some parameters slightly stressed. Investigate local causes."; }
      else { label = "Alert"; text = "Several parameters outside ideal. Action needed."; }
      return {score, label, text};
    }

   // replace supabase read with fetch to your server function:
async function loadLatestSamples(limit = 20) {
  const r = await fetch('/.netlify/functions/latest-samples?limit=' + encodeURIComponent(limit));
  if (!r.ok) {
    console.error('Failed to load latest samples', await r.text());
    return [];
  }
  return await r.json();
}

// usage example:
loadLatestSamples(20).then(samples => {
  // samples is array of rows; render chart/table
  console.log('latest samples', samples);
  renderTable(samples); // your existing renderer function - call it with samples
});
    // render metrics/cards/table/chart using fetched rows
    let tempChart = null;
    async function renderFromServer() {
      const rows = await fetchLatestSamples(20);

      // metric cards
      const metricContainer = document.getElementById('metricCards');
      metricContainer.innerHTML = '';

      const latest = rows[0] || null;
      const cards = [
        { title: "Overall status", value: latest ? getLocalPrediction(latest).label : "No data", unit: latest ? new Date(latest.recorded_at).toLocaleString() : "" },
        { title: "pH (latest)", value: latest ? number(latest.ph) : "—", unit: "ideal 7.8–8.3" },
        { title: "Temperature (°C)", value: latest ? number(latest.temperature) : "—", unit: "ideal 24–30" },
        { title: "Salinity (PSU)", value: latest ? number(latest.salinity) : "—", unit: "ideal 33–36" }
      ];
      cards.forEach(c => {
        const el = document.createElement('article');
        el.className = 'card';
        el.innerHTML = `<h3>${c.title}</h3><div class="metric-value">${c.value}</div><div class="metric-unit">${c.unit}</div>`;
        metricContainer.appendChild(el);
      });

      // table
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td><td>${new Date(r.recorded_at).toLocaleString()}</td><td>${number(r.ph)}</td><td>${number(r.temperature)}</td><td>${number(r.salinity)}</td><td>${number(r.dissolved_oxygen ?? r.dissolvedOxygen)}</td><td>${number(r.turbidity)}</td>`;
        tbody.appendChild(tr);
      });

      // chart (temperatures)
      const labels = rows.map(s => new Date(s.recorded_at).toLocaleTimeString());
      const temps = rows.map(s => Number(s.temperature || 0));
      const ctx = document.getElementById('tempChart').getContext('2d');
      if (tempChart) tempChart.destroy();
      tempChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label:'Temperature (°C)', data: temps, tension:0.3, fill:false }] },
        options: { responsive:true, plugins:{legend:{display:false}} }
      });

      // set initial AI text with local rule for latest
      if (latest) {
        const p = getLocalPrediction(latest);
        setAIText(`Local rule-based status: ${p.label} (score ${p.score}/10)\n\n${p.text}`);
      } else {
        setAIText('No sample data available yet.');
      }
    }

    // subscribe to Supabase realtime for new samples & predictions
    function setupRealtime() {
      // listen to inserts on samples and predictions
      supabase.channel('public:samples')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'samples' }, payload => {
          console.log('New sample inserted', payload.new);
          // re-render from server (easy, simple)
          renderFromServer();
        })
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'predictions' }, payload => {
          console.log('New prediction inserted', payload.new);
          if (payload.new && payload.new.summary) {
            setAIText(String(payload.new.summary).slice(0, 10000));
          }
        })
        .subscribe();
    }

    // Ask server AI (calls Netlify function /marine-ai which uses Perplexity server-side)
    async function askServerAI() {
      try {
        // get latest sample
        const rows = await fetchLatestSamples(1);
        const latest = (rows && rows[0]) ? rows[0] : null;
        if (!latest) { alert('No sample available to analyze.'); return; }

        document.getElementById('btnServerAI').disabled = true;
        document.getElementById('btnServerAI').textContent = 'Asking AI...';

        const resp = await fetch(`${API_BASE}/marine-ai`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ latestSample: latest })
        });

        const json = await resp.json();
        console.log('marine-ai result', json);
        if (json.ai_text) {
          setAIText(String(json.ai_text).slice(0,10000));
        } else if (json.stored && json.stored.summary) {
          setAIText(String(json.stored.summary).slice(0,10000));
        } else {
          setAIText('AI returned unexpected response: ' + JSON.stringify(json));
        }
      } catch (err) {
        console.error('askServerAI error', err);
        alert('AI call failed. Check Netlify function logs and that PERPLEXITY_API_KEY is configured.');
      } finally {
        document.getElementById('btnServerAI').disabled = false;
        document.getElementById('btnServerAI').textContent = 'Ask external AI';
      }
    }

    // local button behavior
    document.getElementById('btnLocalAI').addEventListener('click', async () => {
      const rows = await fetchLatestSamples(1);
      const latest = (rows && rows[0]) ? rows[0] : null;
      const p = getLocalPrediction(latest);
      setAIText(`Local rule-based status: ${p.label} (score ${p.score}/10)\n\n${p.text}`);
    });
    document.getElementById('btnServerAI').addEventListener('click', askServerAI);

    // init on load
    (async function init() {
      await renderFromServer();
      setupRealtime();
    })();
  </script>
</body>
</html>
