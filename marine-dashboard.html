<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marine AI Dashboard — SMART VISION</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <style>
    :root{
      --ocean-900:#032735; --ocean-700:#0b74de; --ocean-500:#39a1ff;
      --bg:#f4f9ff; --card:#ffffff; --muted:#6f8396;
      --ok:#1eae60; --warn:#f5a623; --bad:#e63946;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{font-family:"Poppins",sans-serif; background:var(--bg); color:var(--ocean-900);}

    nav{
      position:sticky; top:0; z-index:1000;
      display:flex; justify-content:center; gap:24px; padding:12px 24px;
      background:linear-gradient(90deg,#0077be,#00a8e8);
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    nav a{
      color:#fff; text-decoration:none; font-weight:700; font-size:16px;
      padding:8px 20px; border-radius:999px; transition:all 0.3s;
    }
    nav a:hover{background:rgba(255,255,255,0.2); transform:translateY(-2px);}

    .hero-header{
      padding:32px 16px 24px; text-align:center;
      background:linear-gradient(135deg,#005fa3,#00a8e8,#39a1ff);
      color:#fff; box-shadow:0 8px 24px rgba(0,0,0,0.15);
    }
    .hero-header h1{font-size:32px; font-weight:900; letter-spacing:0.05em; margin-bottom:8px;}
    .hero-header p{font-size:15px; opacity:0.95;}

    .wrap{max-width:1200px; margin:30px auto; padding:0 20px;}

    .metrics-grid{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px; margin-bottom:30px;
    }
    .metric-card{
      background:linear-gradient(135deg,#fff,#f8fcff);
      border-radius:16px; padding:24px;
      box-shadow:0 10px 30px rgba(0,119,190,0.08);
      border:1px solid rgba(0,119,190,0.1);
      transition:all 0.3s ease;
      position:relative; overflow:hidden;
    }
    .metric-card::before{
      content:''; position:absolute; top:0; left:0; right:0; height:4px;
      background:linear-gradient(90deg,var(--ocean-700),var(--ocean-500));
    }
    .metric-card:hover{transform:translateY(-4px); box-shadow:0 15px 40px rgba(0,119,190,0.15);}
    .metric-label{font-size:13px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:0.5px;}
    .metric-value{
      font-size:36px; font-weight:900; color:var(--ocean-900); margin:12px 0 8px;
      animation:countUp 0.8s ease-out;
    }
    .metric-unit{font-size:13px; color:var(--muted); font-weight:500;}
    .metric-status{
      display:inline-block; margin-top:10px; padding:6px 14px; border-radius:20px;
      font-size:12px; font-weight:700; color:#fff;
    }
    .status-ok{background:var(--ok);}
    .status-warn{background:var(--warn);}
    .status-bad{background:var(--bad);}

    @keyframes countUp{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .dashboard-row{
      display:grid; grid-template-columns:2fr 1.2fr; gap:20px; margin-bottom:30px;
    }
    @media (max-width:900px){.dashboard-row{grid-template-columns:1fr;}}

    .chart-card, .ai-card{
      background:#fff; border-radius:16px; padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,0.06);
      border:1px solid rgba(0,119,190,0.08);
    }
    .chart-card h3, .ai-card h3{margin-bottom:20px; font-size:18px; color:var(--ocean-900);}
    canvas{width:100%; max-height:280px;}

    #aiText{
      width:100%; min-height:200px; border-radius:10px;
      border:1px solid #e5f0f8; padding:14px; font-size:13px; line-height:1.6;
      resize:vertical; background:#f9fbff; font-family:inherit;
    }
    .btn-group{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;}
    .btn{
      padding:11px 20px; border-radius:10px; border:none; font-weight:700; font-size:13px;
      cursor:pointer; transition:all 0.3s; flex:1; min-width:140px;
    }
    .btn-primary{background:linear-gradient(135deg,#39a1ff,#0b74de); color:#fff;}
    .btn-primary:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(11,116,222,0.3);}
    .btn-success{background:linear-gradient(135deg,#1eae60,#0b7c3e); color:#fff;}
    .btn-success:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(30,174,96,0.3);}
    .btn:disabled{opacity:0.6; cursor:not-allowed; transform:none;}

    .table-card{
      background:#fff; border-radius:16px; padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,0.06); margin-top:20px;
      border:1px solid rgba(0,119,190,0.08);
    }
    .table-card h3{margin-bottom:18px; font-size:18px;}
    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{padding:12px 10px; text-align:left; border-bottom:1px solid #e5f0f8;}
    th{background:linear-gradient(135deg,#f0f7fc,#e5f0f8); font-weight:700; color:var(--ocean-900);}
    tbody tr{transition:background 0.2s;}
    tbody tr:hover{background:#f9fbff;}
    .note{margin-top:16px; font-size:12px; color:var(--muted); text-align:center;}

    .loading{
      display:inline-block; width:20px; height:20px;
      border:3px solid rgba(11,116,222,0.2);
      border-top-color:#0b74de; border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{ to{transform:rotate(360deg);} }

    footer{margin:30px 0 20px; text-align:center; font-size:13px; color:var(--muted);}

    .refresh-indicator{
      position:fixed; bottom:20px; right:20px;
      background:#fff; padding:10px 16px; border-radius:30px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1); font-size:12px;
      display:flex; align-items:center; gap:8px; z-index:1000;
      opacity:0; transition:opacity 0.3s;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="live-demo.html">Live Demo</a>
    <a href="marine-dashboard.html">Marine AI Dashboard</a>
  </nav>

  <header class="hero-header">
    <h1>MARINE AI DASHBOARD</h1>
    <p>Real-time ocean parameters + AI health analysis</p>
  </header>

  <main class="wrap">
    <section class="metrics-grid" id="metricsGrid"></section>

    <section class="dashboard-row">
      <div class="chart-card">
        <h3>Temperature Trend (Recent 20 Samples)</h3>
        <canvas id="tempChart"></canvas>
      </div>

      <div class="ai-card">
        <h3>AI Health Insight</h3>
        <textarea id="aiText" readonly placeholder="Click a button below to get AI analysis..."></textarea>
        <div class="btn-group">
          <button class="btn btn-primary" id="btnLocalAI">Local Rules AI</button>
          <button class="btn btn-success" id="btnServerAI">Perplexity AI</button>
        </div>
      </div>
    </section>

    <section class="table-card">
      <h3>Recent Water Quality Samples</h3>
      <table id="dataTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Location</th>
            <th>Time</th>
            <th>pH</th>
            <th>Temp (°C)</th>
            <th>Salinity</th>
            <th>DO (mg/L)</th>
            <th>Turbidity</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="note">Data refreshes automatically every 30 seconds. Add samples via Live Demo page.</p>
    </section>

    <footer>
      Dashboard powered by Vercel + Supabase + Perplexity AI
    </footer>
  </main>

  <div class="refresh-indicator" id="refreshIndicator">
    <div class="loading"></div>
    <span>Loading data...</span>
  </div>

  <script>
    const SUPABASE_URL = "https://gkomibcozmgpjqwymjtn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdrb21pYmNvem1ncGpxd3ltanRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNDIxNjUsImV4cCI6MjA3OTkxODE2NX0.KOOCWn6ZtF_xkeDV7rbxn9zz-TYfttUp_es5MwFbx30";
    const API_BASE = "/api";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let tempChart = null;
    let currentSamples = [];

    function num(v){ return (v == null) ? "—" : Number(v).toFixed(2); }
    function setAIText(t){ document.getElementById('aiText').value = t; }
    function showRefresh(msg){ 
      const el = document.getElementById('refreshIndicator');
      el.querySelector('span').textContent = msg;
      el.style.opacity = '1';
      setTimeout(() => el.style.opacity = '0', 2000);
    }

    function getLocalPrediction(d){
      if (!d) return {score:0, label:'No data', text:'No sample', status:'status-bad'};
      let score = 0;
      if (d.ph >= 7.6 && d.ph <= 8.4) score += 2; else if (d.ph >= 7.2 && d.ph <= 8.8) score += 1;
      if (d.temperature >= 24 && d.temperature <= 30) score += 2; else if (d.temperature >= 22 && d.temperature <= 32) score += 1;
      if (d.salinity >= 33 && d.salinity <= 36) score += 2; else if (d.salinity >= 30 && d.salinity <= 37.5) score += 1;
      if ((d.dissolved_oxygen ?? d.dissolvedOxygen) >= 5.5) score += 2; else if ((d.dissolved_oxygen ?? d.dissolvedOxygen) >= 4) score += 1;
      if ((d.turbidity) <= 5) score += 2; else if ((d.turbidity) <= 8) score += 1;
      let label, text, status;
      if (score >= 8) { label = "Healthy"; text = "Overall water quality is GOOD. Keep monitoring."; status = 'status-ok'; }
      else if (score >= 5) { label = "Watch"; text = "Some parameters slightly stressed. Investigate causes."; status = 'status-warn'; }
      else { label = "Alert"; text = "Several parameters outside ideal. Action needed."; status = 'status-bad'; }
      return {score, label, text, status};
    }

    async function fetchSamples(limit = 20) {
      try {
        const r = await fetch(`${API_BASE}/latest-samples?limit=${limit}`);
        if (!r.ok) throw new Error('Failed to fetch');
        return await r.json();
      } catch (err) {
        console.error('fetchSamples error:', err);
        return [];
      }
    }

    async function renderDashboard() {
      showRefresh('Fetching data...');
      const samples = await fetchSamples(20);
      currentSamples = samples;

    const samples = await fetchSamples(20);
currentSamples = samples;

if (samples.length === 0) {
  showRefresh('No data yet');
  document.getElementById('metricsGrid').innerHTML =
    '<p style="grid-column:1/-1;text-align:center;color:var(--muted);padding:40px">No samples yet. Add data via Live Demo page.</p>';
  return;
}

// use the most recent sample (assumes API returns newest first)
const latest = samples[0];
const pred = getLocalPrediction(latest);


      // Render metric cards
      const metricsGrid = document.getElementById('metricsGrid');
      metricsGrid.innerHTML = `
        <div class="metric-card">
          <div class="metric-label">Overall Status</div>
          <div class="metric-value">${pred.label}</div>
          <div class="metric-unit">${new Date(latest.recorded_at).toLocaleString()}</div>
          <span class="metric-status ${pred.status}">Score: ${pred.score}/10</span>
        </div>
        <div class="metric-card">
          <div class="metric-label">pH Level</div>
          <div class="metric-value">${num(latest.ph)}</div>
          <div class="metric-unit">Ideal: 7.8–8.3</div>
          <span class="metric-status ${latest.ph >= 7.6 && latest.ph <= 8.4 ? 'status-ok' : 'status-warn'}">Current</span>
        </div>
        <div class="metric-card">
          <div class="metric-label">Temperature</div>
          <div class="metric-value">${num(latest.temperature)}</div>
          <div class="metric-unit">°C (Ideal: 24–30)</div>
          <span class="metric-status ${latest.temperature >= 24 && latest.temperature <= 30 ? 'status-ok' : 'status-warn'}">Current</span>
        </div>
        <div class="metric-card">
          <div class="metric-label">Salinity</div>
          <div class="metric-value">${num(latest.salinity)}</div>
          <div class="metric-unit">PSU (Ideal: 33–36)</div>
          <span class="metric-status ${latest.salinity >= 33 && latest.salinity <= 36 ? 'status-ok' : 'status-warn'}">Current</span>
        </div>
      `;

      // Render chart
      const labels = samples.map(s => new Date(s.recorded_at).toLocaleTimeString());
      const temps = samples.map(s => Number(s.temperature || 0));
      const ctx = document.getElementById('tempChart').getContext('2d');
      if (tempChart) tempChart.destroy();
      tempChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.reverse(),
          datasets: [{
            label: 'Temperature (°C)',
            data: temps.reverse(),
            borderColor: '#0b74de',
            backgroundColor: 'rgba(11,116,222,0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: false, grid: { color: '#f0f7fc' } },
            x: { grid: { display: false } }
          }
        }
      });

      // Render table
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = samples.map((s, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${s.location || 'Unknown'}</td>
          <td>${new Date(s.recorded_at).toLocaleString()}</td>
          <td>${num(s.ph)}</td>
          <td>${num(s.temperature)}</td>
          <td>${num(s.salinity)}</td>
          <td>${num(s.dissolved_oxygen)}</td>
          <td>${num(s.turbidity)}</td>
        </tr>
      `).join('');

      // Set initial AI text
      setAIText(`Local Rule-Based Analysis:\n\nStatus: ${pred.label} (${pred.score}/10)\n\n${pred.text}`);
      showRefresh('Data loaded ✓');
    }

    // Real-time updates
    function setupRealtime() {
      supabase.channel('samples_updates')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'samples' }, payload => {
          console.log('New sample detected:', payload.new);
          renderDashboard();
        })
        .subscribe();
    }

    // AI buttons
    document.getElementById('btnLocalAI').addEventListener('click', () => {
      if (currentSamples.length === 0) { alert('No data available'); return; }
      const pred = getLocalPrediction(currentSamples[0]);
      setAIText(`Local Rule-Based Analysis:\n\nStatus: ${pred.label} (Score: ${pred.score}/10)\n\n${pred.text}\n\nThis is a simple rule-based assessment. For detailed AI analysis, click "Perplexity AI".`);
    });

    document.getElementById('btnServerAI').addEventListener('click', async () => {
      if (currentSamples.length === 0) { alert('No data available'); return; }
      try {
        document.getElementById('btnServerAI').disabled = true;
        document.getElementById('btnServerAI').textContent = 'Analyzing...';
        showRefresh('Requesting AI...');

        const resp = await fetch(`${API_BASE}/marine-ai`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ latestSample: currentSamples[0] })
        });

        const json = await resp.json();
        if (json.ai_text) {
          setAIText(json.ai_text);
          showRefresh('AI analysis complete ✓');
        } else {
          setAIText('AI Error: ' + JSON.stringify(json));
        }
      } catch (err) {
        console.error('AI error:', err);
        alert('AI call failed. Check console.');
      } finally {
        document.getElementById('btnServerAI').disabled = false;
        document.getElementById('btnServerAI').textContent = 'Perplexity AI';
      }
    });

    // Auto-refresh every 30 seconds
    setInterval(() => {
      renderDashboard();
    }, 30000);

    // Initial load
    (async function init() {
      await renderDashboard();
      setupRealtime();
    })();
  </script>
</body>
</html>
