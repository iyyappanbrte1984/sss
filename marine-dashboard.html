<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marine AI Dashboard — SMART VISION</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --ocean-900:#032735; --accent:#06a6ff; --bg:#f5fbff; --card:#ffffff; --muted:#6f8396;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#f5fbff,#ffffff)}
    nav{display:flex;gap:18px;align-items:center;padding:14px 20px;background:linear-gradient(90deg,#0077be,#00a8e8);color:#fff;position:sticky;top:0;z-index:20}
    nav a{color:#fff;text-decoration:none;font-weight:700}
    .wrap{max-width:1200px;margin:20px auto;padding:18px}
    .hero{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .hero h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:18px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(6,20,40,0.06)}
    .metric{font-weight:800;font-size:22px}
    .row{display:flex;gap:16px}
    .col{flex:1}
    canvas{width:100%!important;height:260px!important}
    textarea{width:100%;min-height:140px;border-radius:8px;border:1px solid #e6f0fb;padding:10px;background:#fbfdff}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),#0b74de);color:#fff;font-weight:700;cursor:pointer}
    .small{font-size:13px;padding:6px 8px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eef6ff;text-align:left}
    footer{text-align:center;color:var(--muted);margin-top:18px;font-size:13px}
    @media (max-width:900px){ .hero{flex-direction:column;align-items:flex-start} .row{flex-direction:column} }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="live-demo.html">Live Demo</a>
    <a href="marine-dashboard.html">Dashboard</a>
  </nav>

  <main class="wrap">
    <section class="hero">
      <div>
        <h1>Marine AI Dashboard — SMART VISION</h1>
        <div class="muted">Live samples • AI analysis • Trends</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="refreshBtn" class="btn small">Refresh</button>
        <div id="statusPill" class="muted" style="padding-left:6px">Status: idle</div>
      </div>
    </section>

    <section class="grid" id="metricCards" aria-live="polite"></section>

    <section style="margin-top:18px;display:grid;grid-template-columns:2fr 1fr;gap:16px">
      <div class="card">
        <h3 style="margin:0 0 8px">Temperature (recent)</h3>
        <canvas id="tempChart"></canvas>
        <div style="margin-top:10px" class="muted">Auto-updates when new samples arrive.</div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">AI Health Insight</h3>
        <textarea id="aiText" readonly>AI summaries will appear here when you run analysis.</textarea>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button id="btnLocalAI" class="btn small">Local rule AI</button>
          <button id="btnAskAI" class="btn small" style="background:linear-gradient(90deg,#05c46b,#0b7c3e)">Ask AI</button>
        </div>
      </div>
    </section>

    <section style="margin-top:18px" class="card">
      <h3 style="margin:0 0 8px">Latest Samples</h3>
      <table id="dataTable" aria-live="polite">
        <thead><tr><th>#</th><th>Time</th><th>pH</th><th>Temp (°C)</th><th>Salinity</th><th>DO</th><th>Turb</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <footer>© SMART VISION — prototype. Configure Netlify & Supabase for production.</footer>
  </main>

  <script>
    // -------- CONFIG: Replace these with your Supabase project values ----------
    const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";         // <<-- replace
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";              // <<-- replace
    const API_BASE = "/.netlify/functions";                         // Netlify functions base

    // init supabase client (anon key is safe client-side)
    const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI elements
    const statusPill = document.getElementById("statusPill");
    const metricCards = document.getElementById("metricCards");
    const dataTableBody = document.querySelector("#dataTable tbody");
    const aiText = document.getElementById("aiText");
    const btnAskAI = document.getElementById("btnAskAI");
    const btnLocalAI = document.getElementById("btnLocalAI");
    const refreshBtn = document.getElementById("refreshBtn");

    function setStatus(t){ statusPill.textContent = "Status: " + t; }
    function number(v){ return (v === null || v === undefined) ? "—" : Number(v).toFixed(2); }

    // fetch latest samples via Netlify function
    async function fetchLatest(limit=20){
      setStatus("loading latest samples...");
      try {
        const res = await fetch(`${API_BASE}/latest-samples?limit=${limit}`);
        if (!res.ok) throw new Error("latest-samples failed: " + res.status);
        const rows = await res.json();
        setStatus("loaded");
        return rows;
      } catch (err){
        console.error(err);
        setStatus("error loading samples");
        return [];
      }
    }

    // local rule-based health summary (same logic as server)
    function getLocalPrediction(sample){
      if (!sample) return { label:"No Data", score:0, text:"No sample" };
      let score=0;
      const p = sample;
      if (p.ph >=7.6 && p.ph<=8.4) score+=2; else if (p.ph>=7.2 && p.ph<=8.8) score+=1;
      if (p.temperature>=24 && p.temperature<=30) score+=2; else if (p.temperature>=22 && p.temperature<=32) score+=1;
      if (p.salinity>=33 && p.salinity<=36) score+=2; else if (p.salinity>=30 && p.salinity<=37.5) score+=1;
      if ((p.dissolved_oxygen ?? p.dissolvedOxygen) >=5.5) score+=2; else if ((p.dissolved_oxygen ?? p.dissolvedOxygen) >=4) score+=1;
      if (p.turbidity <=5) score+=2; else if (p.turbidity<=8) score+=1;
      let label, text;
      if (score>=8){ label="Healthy"; text="Water quality generally good. Continue monitoring." }
      else if (score>=5){ label="Watch"; text="Some parameters slightly stressed. Investigate local sources." }
      else { label="Alert"; text="Multiple parameters outside ideal range. Action recommended." }
      return { label, score, text };
    }

    // render dashboard UI
    let tempChart=null;
    async function renderDashboard(){
      const rows = await fetchLatest(30);
      // metric cards
      metricCards.innerHTML = "";
      const latest = rows[0] || null;
      const cards = [
        { title:"Latest status", value: latest ? new Date(latest.recorded_at).toLocaleString() : "No data", unit: latest ? "Latest sample" : "" },
        { title:"pH (latest)", value: latest ? number(latest.ph) : "—", unit:"ideal 7.8–8.3" },
        { title:"Temperature (°C)", value: latest ? number(latest.temperature) : "—", unit:"ideal 24–30" },
        { title:"Salinity (PSU)", value: latest ? number(latest.salinity) : "—", unit:"ideal 33–36" },
      ];
      cards.forEach(c=>{
        const el=document.createElement("article"); el.className="card";
        el.innerHTML = `<div class="muted">${c.title}</div><div class="metric">${c.value}</div><div class="muted">${c.unit}</div>`;
        metricCards.appendChild(el);
      });

      // table
      dataTableBody.innerHTML = "";
      rows.forEach((r,i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td>${new Date(r.recorded_at).toLocaleString()}</td><td>${number(r.ph)}</td><td>${number(r.temperature)}</td><td>${number(r.salinity)}</td><td>${number(r.dissolved_oxygen ?? r.dissolvedOxygen)}</td><td>${number(r.turbidity)}</td>`;
        dataTableBody.appendChild(tr);
      });

      // chart
      const labels = rows.map(s => new Date(s.recorded_at).toLocaleTimeString());
      const temps = rows.map(s => Number(s.temperature || 0));
      const ctx = document.getElementById("tempChart").getContext("2d");
      if (tempChart) tempChart.destroy();
      tempChart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label:'Temperature (°C)', data:temps, tension:0.3, fill:true }]},
        options:{ responsive:true, plugins:{legend:{display:false}} }
      });

      // update AI text with local prediction for latest
      const pred = getLocalPrediction(latest);
      aiText.value = `Local rule-based status: ${pred.label} (score ${pred.score}/10)\n\n${pred.text}`;
    }

    // subscribe to realtime updates using Supabase client (insert events)
    function subscribeRealtime(){
      // subscribe to new samples
      supabase.channel('public:samples')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'samples' }, payload => {
          console.log('new sample', payload.new);
          renderDashboard(); // simple approach: re-fetch/render
        })
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'predictions' }, payload => {
          console.log('new prediction', payload.new);
          // show latest prediction text in AI panel
          if (payload.new && payload.new.summary) {
            aiText.value = String(payload.new.summary).slice(0, 400);
          }
        })
        .subscribe();
    }

    // Ask server-side AI (Perplexity) for analysis of latest sample
    async function askServerAI(){
      setStatus("asking AI...");
      try {
        const rows = await fetchLatest(1);
        if (!rows || rows.length === 0) { setStatus("no sample to analyze"); return; }
        const latest = rows[0];
        const res = await fetch(`${API_BASE}/marine-ai`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ latestSample: latest })
        });
        const json = await res.json();
        if (json.ai_text) aiText.value = String(json.ai_text).slice(0,10000);
        setStatus('AI result stored');
      } catch (err) {
        console.error(err);
        setStatus('AI error');
      }
    }

    // UI handlers
    refreshBtn.addEventListener('click', renderDashboard);
    btnAskAI.addEventListener('click', askServerAI);
    btnLocalAI.addEventListener('click', () => {
      fetchLatest(1).then(rows => {
        if (!rows || rows.length === 0) { setStatus("no data"); return; }
        const p = getLocalPrediction(rows[0]);
        aiText.value = `Local rule-based status: ${p.label} (score ${p.score}/10)\n\n${p.text}`;
        setStatus('local AI done');
      });
    });

    // init
    (async function init(){
      setStatus('initializing');
      try {
        await renderDashboard();
        subscribeRealtime();
        setStatus('ready');
      } catch(e){
        console.error(e);
        setStatus('init error');
      }
    })();
  </script>
</body>
</html>
